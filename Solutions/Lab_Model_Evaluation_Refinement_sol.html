<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.56">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Lab - Model Evaluation and Refinement</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="Lab_Model_Evaluation_Refinement_sol_files/libs/clipboard/clipboard.min.js"></script>
<script src="Lab_Model_Evaluation_Refinement_sol_files/libs/quarto-html/quarto.js"></script>
<script src="Lab_Model_Evaluation_Refinement_sol_files/libs/quarto-html/popper.min.js"></script>
<script src="Lab_Model_Evaluation_Refinement_sol_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Lab_Model_Evaluation_Refinement_sol_files/libs/quarto-html/anchor.min.js"></script>
<link href="Lab_Model_Evaluation_Refinement_sol_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Lab_Model_Evaluation_Refinement_sol_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Lab_Model_Evaluation_Refinement_sol_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Lab_Model_Evaluation_Refinement_sol_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Lab_Model_Evaluation_Refinement_sol_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><strong>Lab - Model Evaluation and Refinement</strong></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p><b>ITM-370: Data Analytics</b><br> <strong>Lecturer: HAS Sothea, PhD</strong></p>
<hr>
<p><strong>Objective:</strong> Building a model is (SLR or MLR) is rather simple, but building a good model that can generalize well on unseen observations is more challenging. This practical lab aims at enhancing your practical skills in pushing the performance of your models on new unseen data using techniques introduced in the class.</p>
<blockquote class="blockquote">
<p><strong>The <code>Jupyter Notebook</code> for this Lab can be downloaded here: <a href="https://hassothea.github.io/Data_Analytics_AUPP/Labs/Lab_Model_Evaluation_Refinement.ipynb">Lab_Model_Evaluation_Refinement.ipynb</a></strong>.</p>
</blockquote>
<blockquote class="blockquote">
<p><strong>Or you can work with this notebook in <code>Google Colab</code> here: <a href="https://colab.research.google.com/drive/1olaCH9qshMuwVL3Lp-nqcB7F4nJswMYe?usp=sharing">Lab_Model_Evaluation_Refinement.ipynb</a></strong>.</p>
</blockquote>
<hr>
<section id="importing-abalone-dataset" class="level2">
<h2 class="anchored" data-anchor-id="importing-abalone-dataset">1. Importing <code>Abalone dataset</code></h2>
<p>You need internet to load the data by running the following codes. For more information about this data, read <a href="https://www.kaggle.com/datasets/rodolfomendes/abalone-dataset"><code>Abalone dataset</code></a>.</p>
<div id="cell-3" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># %pip install kagglehub   # if you have not installed "kagglehub" module yet</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> kagglehub</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Download latest version</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> kagglehub.dataset_download(<span class="st">"rodolfomendes/abalone-dataset"</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Path to dataset files:"</span>, path)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Import data</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> pd.read_csv(path <span class="op">+</span> <span class="st">"/abalone.csv"</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>data.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Path to dataset files: C:\Users\hasso\.cache\kagglehub\datasets\rodolfomendes\abalone-dataset\versions\3</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Sex</th>
<th data-quarto-table-cell-role="th">Length</th>
<th data-quarto-table-cell-role="th">Diameter</th>
<th data-quarto-table-cell-role="th">Height</th>
<th data-quarto-table-cell-role="th">Whole weight</th>
<th data-quarto-table-cell-role="th">Shucked weight</th>
<th data-quarto-table-cell-role="th">Viscera weight</th>
<th data-quarto-table-cell-role="th">Shell weight</th>
<th data-quarto-table-cell-role="th">Rings</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>M</td>
<td>0.455</td>
<td>0.365</td>
<td>0.095</td>
<td>0.5140</td>
<td>0.2245</td>
<td>0.1010</td>
<td>0.150</td>
<td>15</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>M</td>
<td>0.350</td>
<td>0.265</td>
<td>0.090</td>
<td>0.2255</td>
<td>0.0995</td>
<td>0.0485</td>
<td>0.070</td>
<td>7</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>F</td>
<td>0.530</td>
<td>0.420</td>
<td>0.135</td>
<td>0.6770</td>
<td>0.2565</td>
<td>0.1415</td>
<td>0.210</td>
<td>9</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>M</td>
<td>0.440</td>
<td>0.365</td>
<td>0.125</td>
<td>0.5160</td>
<td>0.2155</td>
<td>0.1140</td>
<td>0.155</td>
<td>10</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>I</td>
<td>0.330</td>
<td>0.255</td>
<td>0.080</td>
<td>0.2050</td>
<td>0.0895</td>
<td>0.0395</td>
<td>0.055</td>
<td>7</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p><strong>A.</strong> What’s the dimension of this dataset? How many quantitative and qualitative variables are there in this dataset?</p>
<div id="cell-5" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Dimension of the dataset: </span><span class="sc">{</span>data<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Quantitative variables: </span><span class="sc">{</span><span class="bu">list</span>(data.columns[<span class="dv">1</span>:])<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Quanlitative variables: </span><span class="sc">{</span>data<span class="sc">.</span>columns[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Dimension of the dataset: (4177, 9)
Quantitative variables: ['Length', 'Diameter', 'Height', 'Whole weight', 'Shucked weight', 'Viscera weight', 'Shell weight', 'Rings']
Quanlitative variables: Sex</code></pre>
</div>
</div>
<p><strong>B.</strong> Perform univariate analysis (compute statistical values and plot the distribution) on each variables of your dataset. The goal is to understand your data (the scale and how each column is distributed), detect missing values and outliers, etc.</p>
<ul>
<li>Statistical values</li>
</ul>
<div id="cell-8" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>data.iloc[:,<span class="dv">1</span>:].describe().drop(index<span class="op">=</span>[<span class="st">"count"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Length</th>
<th data-quarto-table-cell-role="th">Diameter</th>
<th data-quarto-table-cell-role="th">Height</th>
<th data-quarto-table-cell-role="th">Whole weight</th>
<th data-quarto-table-cell-role="th">Shucked weight</th>
<th data-quarto-table-cell-role="th">Viscera weight</th>
<th data-quarto-table-cell-role="th">Shell weight</th>
<th data-quarto-table-cell-role="th">Rings</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">mean</td>
<td>0.523992</td>
<td>0.407881</td>
<td>0.139516</td>
<td>0.828742</td>
<td>0.359367</td>
<td>0.180594</td>
<td>0.238831</td>
<td>9.933684</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">std</td>
<td>0.120093</td>
<td>0.099240</td>
<td>0.041827</td>
<td>0.490389</td>
<td>0.221963</td>
<td>0.109614</td>
<td>0.139203</td>
<td>3.224169</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">min</td>
<td>0.075000</td>
<td>0.055000</td>
<td>0.000000</td>
<td>0.002000</td>
<td>0.001000</td>
<td>0.000500</td>
<td>0.001500</td>
<td>1.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">25%</td>
<td>0.450000</td>
<td>0.350000</td>
<td>0.115000</td>
<td>0.441500</td>
<td>0.186000</td>
<td>0.093500</td>
<td>0.130000</td>
<td>8.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">50%</td>
<td>0.545000</td>
<td>0.425000</td>
<td>0.140000</td>
<td>0.799500</td>
<td>0.336000</td>
<td>0.171000</td>
<td>0.234000</td>
<td>9.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">75%</td>
<td>0.615000</td>
<td>0.480000</td>
<td>0.165000</td>
<td>1.153000</td>
<td>0.502000</td>
<td>0.253000</td>
<td>0.329000</td>
<td>11.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">max</td>
<td>0.815000</td>
<td>0.650000</td>
<td>1.130000</td>
<td>2.825500</td>
<td>1.488000</td>
<td>0.760000</td>
<td>1.005000</td>
<td>29.000000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-9" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>data[[<span class="st">"Sex"</span>]].value_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>Sex
M      1528
I      1342
F      1307
Name: count, dtype: int64</code></pre>
</div>
</div>
<blockquote class="blockquote">
<p>There seems to be some Analone with <span class="math inline">\(0.0\)</span> height which are not reasonable. These are missing values and we should detect it.</p>
</blockquote>
<div id="cell-11" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>n_missing <span class="op">=</span> (data.Height <span class="op">==</span> <span class="dv">0</span>).<span class="bu">sum</span>()</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'The number of missing values: </span><span class="sc">{</span>n_missing<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The number of missing values: 2</code></pre>
</div>
</div>
<p>It’s just a very small proportion of the data, we don’t need waste time investigating its type missing type. We go ahead and drop these missing values.</p>
<div id="cell-13" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> data.loc[data.Height <span class="op">&gt;</span> <span class="dv">0</span>,:]</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>data.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Length</th>
<th data-quarto-table-cell-role="th">Diameter</th>
<th data-quarto-table-cell-role="th">Height</th>
<th data-quarto-table-cell-role="th">Whole weight</th>
<th data-quarto-table-cell-role="th">Shucked weight</th>
<th data-quarto-table-cell-role="th">Viscera weight</th>
<th data-quarto-table-cell-role="th">Shell weight</th>
<th data-quarto-table-cell-role="th">Rings</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">count</td>
<td>4175.000000</td>
<td>4175.00000</td>
<td>4175.000000</td>
<td>4175.000000</td>
<td>4175.000000</td>
<td>4175.000000</td>
<td>4175.000000</td>
<td>4175.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mean</td>
<td>0.524065</td>
<td>0.40794</td>
<td>0.139583</td>
<td>0.829005</td>
<td>0.359476</td>
<td>0.180653</td>
<td>0.238834</td>
<td>9.935090</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">std</td>
<td>0.120069</td>
<td>0.09922</td>
<td>0.041725</td>
<td>0.490349</td>
<td>0.221954</td>
<td>0.109605</td>
<td>0.139212</td>
<td>3.224227</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">min</td>
<td>0.075000</td>
<td>0.05500</td>
<td>0.010000</td>
<td>0.002000</td>
<td>0.001000</td>
<td>0.000500</td>
<td>0.001500</td>
<td>1.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">25%</td>
<td>0.450000</td>
<td>0.35000</td>
<td>0.115000</td>
<td>0.442250</td>
<td>0.186250</td>
<td>0.093500</td>
<td>0.130000</td>
<td>8.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">50%</td>
<td>0.545000</td>
<td>0.42500</td>
<td>0.140000</td>
<td>0.800000</td>
<td>0.336000</td>
<td>0.171000</td>
<td>0.234000</td>
<td>9.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">75%</td>
<td>0.615000</td>
<td>0.48000</td>
<td>0.165000</td>
<td>1.153500</td>
<td>0.502000</td>
<td>0.253000</td>
<td>0.328750</td>
<td>11.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">max</td>
<td>0.815000</td>
<td>0.65000</td>
<td>1.130000</td>
<td>2.825500</td>
<td>1.488000</td>
<td>0.760000</td>
<td>1.005000</td>
<td>29.000000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<ul>
<li>Visualize the distribution of the columns</li>
</ul>
<div id="cell-15" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>quan_vars <span class="op">=</span> data.columns[<span class="dv">1</span>:]</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>qual_var <span class="op">=</span> <span class="st">"Sex"</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>sns.<span class="bu">set</span>(style<span class="op">=</span><span class="st">"whitegrid"</span>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>_, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>,<span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">9</span>, <span class="dv">4</span>))</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>sns.countplot(data, x<span class="op">=</span><span class="st">"Sex"</span>, ax<span class="op">=</span>ax[<span class="dv">0</span>])</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_title(<span class="st">"Barplot of variable Sex"</span>)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_title</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>sns.boxplot(data[quan_vars[:<span class="op">-</span><span class="dv">1</span>]].melt(), x<span class="op">=</span><span class="st">"variable"</span>, y<span class="op">=</span><span class="st">"value"</span>, hue<span class="op">=</span><span class="st">"variable"</span>, ax<span class="op">=</span>ax[<span class="dv">1</span>])</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].tick_params(labelrotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_title(<span class="st">"The distribution of quantitative inputs"</span>)</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_xlabel(<span class="st">""</span>)</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>sns.boxplot(data, y<span class="op">=</span><span class="st">"Rings"</span>, ax<span class="op">=</span>ax[<span class="dv">2</span>])</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">2</span>].set_title(<span class="st">"The distribution of the Rings"</span>)</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">2</span>].set_xlabel(<span class="st">"The target"</span>)</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab_Model_Evaluation_Refinement_sol_files/figure-html/cell-8-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<blockquote class="blockquote">
<p>It looks like there are some outliers in both the target and inputs. We just notice this but proceed without removing them.</p>
</blockquote>
</section>
<section id="correlation-matrix-slr-and-mlr" class="level2">
<h2 class="anchored" data-anchor-id="correlation-matrix-slr-and-mlr">2. Correlation matrix, SLR and MLR</h2>
<p><strong>A.</strong> Compute the correlation matrix of this data using <code>pd.corr()</code> function. Describe what you observed from this correlation matrix.</p>
<div id="cell-18" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>data[quan_vars].corr().style.background_gradient()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<style type="text/css">
#T_cb7f1_row0_col0, #T_cb7f1_row1_col1, #T_cb7f1_row2_col2, #T_cb7f1_row3_col3, #T_cb7f1_row4_col4, #T_cb7f1_row5_col5, #T_cb7f1_row6_col6, #T_cb7f1_row7_col7 {
  background-color: #023858;
  color: #f1f1f1;
}
#T_cb7f1_row0_col1, #T_cb7f1_row1_col0 {
  background-color: #023f64;
  color: #f1f1f1;
}
#T_cb7f1_row0_col2, #T_cb7f1_row2_col0, #T_cb7f1_row2_col1, #T_cb7f1_row2_col4 {
  background-color: #3d93c2;
  color: #f1f1f1;
}
#T_cb7f1_row0_col3, #T_cb7f1_row1_col3 {
  background-color: #046097;
  color: #f1f1f1;
}
#T_cb7f1_row0_col4 {
  background-color: #04639b;
  color: #f1f1f1;
}
#T_cb7f1_row0_col5 {
  background-color: #0567a1;
  color: #f1f1f1;
}
#T_cb7f1_row0_col6 {
  background-color: #0d75b3;
  color: #f1f1f1;
}
#T_cb7f1_row0_col7, #T_cb7f1_row2_col7 {
  background-color: #d3d4e7;
  color: #000000;
}
#T_cb7f1_row1_col2 {
  background-color: #358fc0;
  color: #f1f1f1;
}
#T_cb7f1_row1_col4, #T_cb7f1_row6_col5 {
  background-color: #04649e;
  color: #f1f1f1;
}
#T_cb7f1_row1_col5, #T_cb7f1_row6_col4 {
  background-color: #0567a2;
  color: #f1f1f1;
}
#T_cb7f1_row1_col6, #T_cb7f1_row4_col1 {
  background-color: #0570b0;
  color: #f1f1f1;
}
#T_cb7f1_row1_col7 {
  background-color: #cccfe5;
  color: #000000;
}
#T_cb7f1_row2_col3 {
  background-color: #3f93c2;
  color: #f1f1f1;
}
#T_cb7f1_row2_col5 {
  background-color: #4496c3;
  color: #f1f1f1;
}
#T_cb7f1_row2_col6 {
  background-color: #6da6cd;
  color: #f1f1f1;
}
#T_cb7f1_row3_col0 {
  background-color: #046299;
  color: #f1f1f1;
}
#T_cb7f1_row3_col1 {
  background-color: #04629a;
  color: #f1f1f1;
}
#T_cb7f1_row3_col2, #T_cb7f1_row6_col2 {
  background-color: #4697c4;
  color: #f1f1f1;
}
#T_cb7f1_row3_col4 {
  background-color: #03466e;
  color: #f1f1f1;
}
#T_cb7f1_row3_col5, #T_cb7f1_row4_col3 {
  background-color: #034a74;
  color: #f1f1f1;
}
#T_cb7f1_row3_col6, #T_cb7f1_row5_col4 {
  background-color: #04588a;
  color: #f1f1f1;
}
#T_cb7f1_row3_col7 {
  background-color: #dad9ea;
  color: #000000;
}
#T_cb7f1_row4_col0, #T_cb7f1_row6_col0 {
  background-color: #056caa;
  color: #f1f1f1;
}
#T_cb7f1_row4_col2 {
  background-color: #76aad0;
  color: #f1f1f1;
}
#T_cb7f1_row4_col5 {
  background-color: #045c90;
  color: #f1f1f1;
}
#T_cb7f1_row4_col6 {
  background-color: #1e80b8;
  color: #f1f1f1;
}
#T_cb7f1_row4_col7, #T_cb7f1_row7_col0, #T_cb7f1_row7_col1, #T_cb7f1_row7_col2, #T_cb7f1_row7_col3, #T_cb7f1_row7_col4, #T_cb7f1_row7_col5, #T_cb7f1_row7_col6 {
  background-color: #fff7fb;
  color: #000000;
}
#T_cb7f1_row5_col0, #T_cb7f1_row6_col1 {
  background-color: #056ba7;
  color: #f1f1f1;
}
#T_cb7f1_row5_col1 {
  background-color: #056dac;
  color: #f1f1f1;
}
#T_cb7f1_row5_col2 {
  background-color: #5ea0ca;
  color: #f1f1f1;
}
#T_cb7f1_row5_col3 {
  background-color: #034b76;
  color: #f1f1f1;
}
#T_cb7f1_row5_col6 {
  background-color: #056faf;
  color: #f1f1f1;
}
#T_cb7f1_row5_col7 {
  background-color: #e8e4f0;
  color: #000000;
}
#T_cb7f1_row6_col3 {
  background-color: #045280;
  color: #f1f1f1;
}
#T_cb7f1_row6_col7 {
  background-color: #acc0dd;
  color: #000000;
}
</style>

<table id="T_cb7f1" class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th class="blank level0" data-quarto-table-cell-role="th">&nbsp;</th>
<th id="T_cb7f1_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">Length</th>
<th id="T_cb7f1_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">Diameter</th>
<th id="T_cb7f1_level0_col2" class="col_heading level0 col2" data-quarto-table-cell-role="th">Height</th>
<th id="T_cb7f1_level0_col3" class="col_heading level0 col3" data-quarto-table-cell-role="th">Whole weight</th>
<th id="T_cb7f1_level0_col4" class="col_heading level0 col4" data-quarto-table-cell-role="th">Shucked weight</th>
<th id="T_cb7f1_level0_col5" class="col_heading level0 col5" data-quarto-table-cell-role="th">Viscera weight</th>
<th id="T_cb7f1_level0_col6" class="col_heading level0 col6" data-quarto-table-cell-role="th">Shell weight</th>
<th id="T_cb7f1_level0_col7" class="col_heading level0 col7" data-quarto-table-cell-role="th">Rings</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_cb7f1_level0_row0" class="row_heading level0 row0" data-quarto-table-cell-role="th">Length</td>
<td id="T_cb7f1_row0_col0" class="data row0 col0">1.000000</td>
<td id="T_cb7f1_row0_col1" class="data row0 col1">0.986802</td>
<td id="T_cb7f1_row0_col2" class="data row0 col2">0.828108</td>
<td id="T_cb7f1_row0_col3" class="data row0 col3">0.925217</td>
<td id="T_cb7f1_row0_col4" class="data row0 col4">0.897859</td>
<td id="T_cb7f1_row0_col5" class="data row0 col5">0.902960</td>
<td id="T_cb7f1_row0_col6" class="data row0 col6">0.898419</td>
<td id="T_cb7f1_row0_col7" class="data row0 col7">0.556464</td>
</tr>
<tr class="even">
<td id="T_cb7f1_level0_row1" class="row_heading level0 row1" data-quarto-table-cell-role="th">Diameter</td>
<td id="T_cb7f1_row1_col0" class="data row1 col0">0.986802</td>
<td id="T_cb7f1_row1_col1" class="data row1 col1">1.000000</td>
<td id="T_cb7f1_row1_col2" class="data row1 col2">0.834298</td>
<td id="T_cb7f1_row1_col3" class="data row1 col3">0.925414</td>
<td id="T_cb7f1_row1_col4" class="data row1 col4">0.893108</td>
<td id="T_cb7f1_row1_col5" class="data row1 col5">0.899672</td>
<td id="T_cb7f1_row1_col6" class="data row1 col6">0.906084</td>
<td id="T_cb7f1_row1_col7" class="data row1 col7">0.574418</td>
</tr>
<tr class="odd">
<td id="T_cb7f1_level0_row2" class="row_heading level0 row2" data-quarto-table-cell-role="th">Height</td>
<td id="T_cb7f1_row2_col0" class="data row2 col0">0.828108</td>
<td id="T_cb7f1_row2_col1" class="data row2 col1">0.834298</td>
<td id="T_cb7f1_row2_col2" class="data row2 col2">1.000000</td>
<td id="T_cb7f1_row2_col3" class="data row2 col3">0.819886</td>
<td id="T_cb7f1_row2_col4" class="data row2 col4">0.775621</td>
<td id="T_cb7f1_row2_col5" class="data row2 col5">0.798908</td>
<td id="T_cb7f1_row2_col6" class="data row2 col6">0.819596</td>
<td id="T_cb7f1_row2_col7" class="data row2 col7">0.557625</td>
</tr>
<tr class="even">
<td id="T_cb7f1_level0_row3" class="row_heading level0 row3" data-quarto-table-cell-role="th">Whole weight</td>
<td id="T_cb7f1_row3_col0" class="data row3 col0">0.925217</td>
<td id="T_cb7f1_row3_col1" class="data row3 col1">0.925414</td>
<td id="T_cb7f1_row3_col2" class="data row3 col2">0.819886</td>
<td id="T_cb7f1_row3_col3" class="data row3 col3">1.000000</td>
<td id="T_cb7f1_row3_col4" class="data row3 col4">0.969389</td>
<td id="T_cb7f1_row3_col5" class="data row3 col5">0.966354</td>
<td id="T_cb7f1_row3_col6" class="data row3 col6">0.955924</td>
<td id="T_cb7f1_row3_col7" class="data row3 col7">0.540151</td>
</tr>
<tr class="odd">
<td id="T_cb7f1_level0_row4" class="row_heading level0 row4" data-quarto-table-cell-role="th">Shucked weight</td>
<td id="T_cb7f1_row4_col0" class="data row4 col0">0.897859</td>
<td id="T_cb7f1_row4_col1" class="data row4 col1">0.893108</td>
<td id="T_cb7f1_row4_col2" class="data row4 col2">0.775621</td>
<td id="T_cb7f1_row4_col3" class="data row4 col3">0.969389</td>
<td id="T_cb7f1_row4_col4" class="data row4 col4">1.000000</td>
<td id="T_cb7f1_row4_col5" class="data row4 col5">0.931924</td>
<td id="T_cb7f1_row4_col6" class="data row4 col6">0.883129</td>
<td id="T_cb7f1_row4_col7" class="data row4 col7">0.420597</td>
</tr>
<tr class="even">
<td id="T_cb7f1_level0_row5" class="row_heading level0 row5" data-quarto-table-cell-role="th">Viscera weight</td>
<td id="T_cb7f1_row5_col0" class="data row5 col0">0.902960</td>
<td id="T_cb7f1_row5_col1" class="data row5 col1">0.899672</td>
<td id="T_cb7f1_row5_col2" class="data row5 col2">0.798908</td>
<td id="T_cb7f1_row5_col3" class="data row5 col3">0.966354</td>
<td id="T_cb7f1_row5_col4" class="data row5 col4">0.931924</td>
<td id="T_cb7f1_row5_col5" class="data row5 col5">1.000000</td>
<td id="T_cb7f1_row5_col6" class="data row5 col6">0.908186</td>
<td id="T_cb7f1_row5_col7" class="data row5 col7">0.503562</td>
</tr>
<tr class="odd">
<td id="T_cb7f1_level0_row6" class="row_heading level0 row6" data-quarto-table-cell-role="th">Shell weight</td>
<td id="T_cb7f1_row6_col0" class="data row6 col0">0.898419</td>
<td id="T_cb7f1_row6_col1" class="data row6 col1">0.906084</td>
<td id="T_cb7f1_row6_col2" class="data row6 col2">0.819596</td>
<td id="T_cb7f1_row6_col3" class="data row6 col3">0.955924</td>
<td id="T_cb7f1_row6_col4" class="data row6 col4">0.883129</td>
<td id="T_cb7f1_row6_col5" class="data row6 col5">0.908186</td>
<td id="T_cb7f1_row6_col6" class="data row6 col6">1.000000</td>
<td id="T_cb7f1_row6_col7" class="data row6 col7">0.627928</td>
</tr>
<tr class="even">
<td id="T_cb7f1_level0_row7" class="row_heading level0 row7" data-quarto-table-cell-role="th">Rings</td>
<td id="T_cb7f1_row7_col0" class="data row7 col0">0.556464</td>
<td id="T_cb7f1_row7_col1" class="data row7 col1">0.574418</td>
<td id="T_cb7f1_row7_col2" class="data row7 col2">0.557625</td>
<td id="T_cb7f1_row7_col3" class="data row7 col3">0.540151</td>
<td id="T_cb7f1_row7_col4" class="data row7 col4">0.420597</td>
<td id="T_cb7f1_row7_col5" class="data row7 col5">0.503562</td>
<td id="T_cb7f1_row7_col6" class="data row7 col6">0.627928</td>
<td id="T_cb7f1_row7_col7" class="data row7 col7">1.000000</td>
</tr>
</tbody>
</table>
</div>
</div>
<blockquote class="blockquote">
<p>It appears that “Shell wieght” is the most correlated input to the target with the highest correlation around <span class="math inline">\(0.63\)</span> while other input-output correlations ranged from <span class="math inline">\(0.42\)</span> tà <span class="math inline">\(0.56\)</span>, and <strong>Shucked Weight</strong> is the less informative one. Lastly, it’s worth noted that there are many highly correlated inputs in this dataset with the highest colinearity greater than $0.98£ between <code>Diameter</code> and <code>Length</code>.</p>
</blockquote>
<p><strong>B.</strong> Draw the scatterplot of the target <code>Rings</code> vs the most correlated input.</p>
<div id="cell-21" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">6</span>, <span class="dv">4</span>))</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>sns.scatterplot(data, x<span class="op">=</span><span class="st">"Shell weight"</span>, y<span class="op">=</span><span class="st">"Rings"</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Scatterplot of Rings vs Shell weight"</span>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>plt.show(block<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab_Model_Evaluation_Refinement_sol_files/figure-html/cell-10-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<blockquote class="blockquote">
<p>This scatterplot shows that Shell Weight seems to carry significant information about the Rings. Analone with heavier shell weights tend to have more rings.</p>
</blockquote>
<ul>
<li>Here, I split the data into two parts. You are allowed to use only the training part for building models. The testing part will be used to evaluate the models’ performance.</li>
</ul>
<div id="cell-24" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>                                        data.iloc[:,<span class="dv">1</span>:<span class="dv">8</span>], </span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>                                        data[<span class="st">'Rings'</span>], </span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>                                        test_size<span class="op">=</span><span class="fl">0.2</span>, </span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>                                        random_state<span class="op">=</span><span class="dv">42</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>C.</strong> Fit a SLR model using the most correlated input to predict the <code>Rings</code> of abalone. - Draw the fitted line on the previous scatterplot. - Compute <span class="math inline">\(R^2\)</span> and explain the observed value. - Compute Mean Suared Error on the test data (Test MSE). - Analyze the residuals and conclude.</p>
<div id="cell-26" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit SLR model</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LinearRegression</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the SLR model</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>slr <span class="op">=</span> LinearRegression().fit(X_train[[<span class="st">'Shell weight'</span>]], y_train)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>y_hat <span class="op">=</span> slr.predict(X_test[[<span class="st">"Shell weight"</span>]])                   <span class="co"># make prediction on the test data</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit linear line to the scatterplot</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">6</span>, <span class="dv">4</span>))</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>sns.scatterplot(data, x<span class="op">=</span><span class="st">"Shell weight"</span>, y<span class="op">=</span><span class="st">"Rings"</span>)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>plt.plot(X_test[<span class="st">'Shell weight'</span>], y_hat, <span class="st">'r'</span>, label<span class="op">=</span><span class="st">"Fitted line"</span>)</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Scatterplot of Rings vs Shell weight"</span>)</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab_Model_Evaluation_Refinement_sol_files/figure-html/cell-12-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-27" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> r2_score, mean_squared_error</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>pred_train <span class="op">=</span> slr.predict(X_train[[<span class="st">'Shell weight'</span>]])</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'R-squared: </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">round</span>(r2_score(y_train, pred_train),<span class="dv">3</span>)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Test MSE: </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">round</span>(mean_squared_error(y_test, y_hat),<span class="dv">3</span>)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>R-squared: 0.392
Test MSE: 6.841</code></pre>
</div>
</div>
<blockquote class="blockquote">
<p>R-squared indicates that around 40% variation of the target <code>Rings</code> can be captured or explained by the model. Now look at the residuals.</p>
</blockquote>
<div id="cell-29" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>resid <span class="op">=</span> pd.DataFrame({</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"True"</span> : y_train,</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Fitted values"</span>: pred_train,</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Residual"</span>: y_train<span class="op">-</span>pred_train}</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>_, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>,<span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">4</span>))</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>sns.scatterplot(resid, x<span class="op">=</span><span class="st">"Fitted values"</span>, y<span class="op">=</span><span class="st">"True"</span>, ax<span class="op">=</span>ax[<span class="dv">0</span>])</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span>[np.<span class="bu">min</span>(y_train), np.<span class="bu">max</span>(y_train)], y<span class="op">=</span>[np.<span class="bu">min</span>(y_train), np.<span class="bu">max</span>(y_train)], ax<span class="op">=</span>ax[<span class="dv">0</span>], color<span class="op">=</span><span class="st">"red"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_title(<span class="st">"True vs predictions"</span>)</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>sns.scatterplot(resid, x<span class="op">=</span><span class="st">"Fitted values"</span>, y<span class="op">=</span><span class="st">"Residual"</span>, ax<span class="op">=</span>ax[<span class="dv">1</span>])</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span>[np.<span class="bu">min</span>(pred_train), np.<span class="bu">max</span>(pred_train)], y<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">0</span>], ax<span class="op">=</span>ax[<span class="dv">1</span>], color<span class="op">=</span><span class="st">"red"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_title(<span class="st">"Residuals vs fitted values"</span>)</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>sns.histplot(resid, x<span class="op">=</span><span class="st">"Residual"</span>, ax<span class="op">=</span>ax[<span class="dv">2</span>])</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">2</span>].set_title(<span class="st">"Density of residuals"</span>)</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab_Model_Evaluation_Refinement_sol_files/figure-html/cell-14-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<blockquote class="blockquote">
<p>It’s clear that the model did not capture all the information from the target as the points in the first graph are not aligned closely to the red line <span class="math inline">\(y=x\)</span>. The residuals are not symmetrically distributed around horizontal axis in the second graph, and the variance is not consistent either. The third graph tells us that the residuals seem not normally distributed.</p>
</blockquote>
<p><strong>D.</strong> Fit MLR using all inputs. Compute: - Compute <span class="math inline">\(R^2\)</span>, adjusted <span class="math inline">\(R_{\text{adj}}^2\)</span> and explain the observed value. - Compute Mean Suared Error on the test data (Test MSE). - Analyze the residuals and conclude.</p>
<div id="cell-32" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the MLR model</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>mlr <span class="op">=</span> LinearRegression().fit(X_train, y_train)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>y_hat1 <span class="op">=</span> mlr.predict(X_test)                   <span class="co"># make prediction on the test data</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>pred_train1 <span class="op">=</span> mlr.predict(X_train)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>n, d <span class="op">=</span> X_train.shape</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'R-squared: </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">round</span>(r2_score(y_train, pred_train1),<span class="dv">3</span>)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Adjusted R-squared: </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">round</span>(<span class="dv">1</span><span class="op">-</span>(<span class="dv">1</span><span class="op">-</span>r2_score(y_train, pred_train1))<span class="op">*</span>(n<span class="op">-</span><span class="dv">1</span>)<span class="op">/</span>(n<span class="op">-</span>d<span class="op">-</span><span class="dv">1</span>),<span class="dv">3</span>)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Test MSE: </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">round</span>(mean_squared_error(y_test, y_hat1),<span class="dv">3</span>)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>All_Test_MSE <span class="op">=</span> {<span class="st">"SLR"</span>: mean_squared_error(y_test, y_hat1)}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>R-squared: 0.518
Adjusted R-squared: 0.517
Test MSE: 5.049</code></pre>
</div>
</div>
<blockquote class="blockquote">
<p>This model seems to do a better job than SLR with R-squared around <span class="math inline">\(0.5\)</span> means that the model can capture around 52% of the variation of the target.</p>
</blockquote>
<div id="cell-34" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>resid1 <span class="op">=</span> pd.DataFrame({</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"True"</span> : y_train,</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Fitted values"</span>: pred_train1,</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Residual"</span>: y_train<span class="op">-</span>pred_train1}</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>_, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>,<span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">4</span>))</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>sns.scatterplot(resid1, x<span class="op">=</span><span class="st">"Fitted values"</span>, y<span class="op">=</span><span class="st">"True"</span>, ax<span class="op">=</span>ax[<span class="dv">0</span>])</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span>[np.<span class="bu">min</span>(y_train), np.<span class="bu">max</span>(y_train)], y<span class="op">=</span>[np.<span class="bu">min</span>(y_train), np.<span class="bu">max</span>(y_train)], ax<span class="op">=</span>ax[<span class="dv">0</span>], color<span class="op">=</span><span class="st">"red"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_title(<span class="st">"True vs predictions"</span>)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>sns.scatterplot(resid, x<span class="op">=</span><span class="st">"Fitted values"</span>, y<span class="op">=</span><span class="st">"Residual"</span>, ax<span class="op">=</span>ax[<span class="dv">1</span>])</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span>[np.<span class="bu">min</span>(pred_train1), np.<span class="bu">max</span>(pred_train1)], y<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">0</span>], ax<span class="op">=</span>ax[<span class="dv">1</span>], color<span class="op">=</span><span class="st">"red"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_title(<span class="st">"Residuals vs fitted values"</span>)</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>sns.histplot(resid1, x<span class="op">=</span><span class="st">"Residual"</span>, ax<span class="op">=</span>ax[<span class="dv">2</span>])</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">2</span>].set_title(<span class="st">"Density of residuals"</span>)</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab_Model_Evaluation_Refinement_sol_files/figure-html/cell-16-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<blockquote class="blockquote">
<p>The residuals also seem to be better than the previous SLR model (the first graph) but there are still many pattern left in the residuals.</p>
</blockquote>
</section>
<section id="polynomial-regression-and-regularized-linear-models" class="level2">
<h2 class="anchored" data-anchor-id="polynomial-regression-and-regularized-linear-models">3. Polynomial Regression and Regularized Linear Models</h2>
<p><strong>A.</strong> Build polynomial regression with different degree <span class="math inline">\(n\in\{2,3,...,10\}\)</span> of the best correlated input to predict <code>Rings</code>. Compute Test MSE for each case.</p>
<div id="cell-37" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> PolynomialFeatures</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>degrees <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">2</span>,<span class="dv">11</span>))</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>mse <span class="op">=</span> []</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> deg <span class="kw">in</span> degrees:</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    poly <span class="op">=</span> PolynomialFeatures(degree<span class="op">=</span>deg)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    X_poly <span class="op">=</span> poly.fit_transform(X_train[[<span class="st">'Shell weight'</span>]])</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> LinearRegression().fit(X_poly, y_train)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># MSE</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    X_poly_test <span class="op">=</span> poly.transform(X_test[[<span class="st">'Shell weight'</span>]])</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    mse.append(mean_squared_error(y_test, model.predict(X_poly_test)))</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    All_Test_MSE[<span class="st">'Poly. '</span><span class="op">+</span><span class="bu">str</span>(deg)] <span class="op">=</span> mean_squared_error(y_test, model.predict(X_poly_test))</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">7</span>,<span class="dv">4</span>))</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>plt.plot(degrees, mse, label<span class="op">=</span><span class="st">"Test MSE"</span>)</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Test MSE at each degree"</span>)</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Degree"</span>)</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Test MSE"</span>)</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab_Model_Evaluation_Refinement_sol_files/figure-html/cell-17-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<blockquote class="blockquote">
<p>This graph indicates that degree <span class="math inline">\(3\)</span> polynomial features of <strong>Shell weight</strong> appear to have the best performance in predicting the testing data, as evidenced by the lowest Test MSE. This suggests that a polynomial of degree <span class="math inline">\(3\)</span> may be a more effective model than a linear one. However, to ensure a comprehensive evaluation, we can perform cross-validation to assess the overall performance of polynomials with different degrees across various subsets of the training data</p>
</blockquote>
<ul>
<li>Perform <span class="math inline">\(10\)</span>-fold Cross-validation to select the best degree <span class="math inline">\(n\)</span>. Hint: see <a href="https://hassothea.github.io/Data_Analytics_AUPP/slides/Model_Evaluation_Refinement.html#/overcoming-overfitting">slide 20</a>.</li>
</ul>
<div id="cell-40" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> cross_val_score</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>cv_mse <span class="op">=</span> []</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>CV_ALL_MSE <span class="op">=</span> {}</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> deg <span class="kw">in</span> degrees:</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    poly <span class="op">=</span> PolynomialFeatures(degree<span class="op">=</span>deg)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    X_poly <span class="op">=</span> poly.fit_transform(X_train[[<span class="st">'Shell weight'</span>]])</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> LinearRegression()</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    mse_ <span class="op">=</span> <span class="op">-</span>cross_val_score(model, X_poly, y_train, cv<span class="op">=</span><span class="dv">10</span>, scoring<span class="op">=</span><span class="st">"neg_mean_squared_error"</span>).mean()</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    CV_ALL_MSE[<span class="st">'Poly. '</span><span class="op">+</span><span class="bu">str</span>(deg)] <span class="op">=</span> mse_</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># MSE</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    cv_mse.append(mse_)</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>opt_deg <span class="op">=</span> np.argmin(cv_mse)</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Optimal CV MSE: </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">min</span>(np.<span class="bu">round</span>(cv_mse,<span class="dv">3</span>))<span class="sc">}</span><span class="ss"> at optimal degree:</span><span class="sc">{</span>opt_deg<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">7</span>,<span class="dv">4</span>))</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>plt.plot(degrees, cv_mse, label<span class="op">=</span><span class="st">"CV MSE"</span>)</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>plt.vlines(opt_deg, ymin<span class="op">=</span>np.<span class="bu">min</span>(cv_mse), ymax<span class="op">=</span>np.<span class="bu">max</span>(cv_mse), linestyles<span class="op">=</span><span class="st">'--'</span>, colors<span class="op">=</span><span class="st">'red'</span>, label<span class="op">=</span><span class="st">"Optimal degree"</span>)</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"CV MSE at each degree"</span>)</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Degree"</span>)</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"CV MSE"</span>)</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Optimal CV MSE: 5.877 at optimal degree:4</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab_Model_Evaluation_Refinement_sol_files/figure-html/cell-18-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<blockquote class="blockquote">
<p>This graph reveals that polynomial degree <span class="math inline">\(4\)</span> is slightly better than polynomial degree <span class="math inline">\(3\)</span> in predicting different subsets of the data via cross-validation splits. However, we should not feel that degree <span class="math inline">\(4\)</span> is really better than <span class="math inline">\(2,3,5,6\)</span> and <span class="math inline">\(7\)</span> because the differences in MSE are too insignificant.</p>
</blockquote>
<ul>
<li>Let’s see how they fits to the data:</li>
</ul>
<div id="cell-43" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">7</span>, <span class="dv">5</span>))</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>sns.scatterplot(data, x<span class="op">=</span><span class="st">"Shell weight"</span>, y<span class="op">=</span><span class="st">"Rings"</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> plt.cm.viridis(np.linspace(<span class="dv">0</span>, <span class="dv">1</span>, <span class="bu">len</span>(degrees)))</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit degree 4 model</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> deg, col <span class="kw">in</span> <span class="bu">zip</span>(degrees, colors):</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    poly <span class="op">=</span> PolynomialFeatures(degree<span class="op">=</span>deg)</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    X_poly <span class="op">=</span> poly.fit_transform(X_train[[<span class="st">'Shell weight'</span>]])</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    ply <span class="op">=</span> LinearRegression().fit(X_poly, y_train)</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    y_poly_pred <span class="op">=</span> ply.predict(X_poly)</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    id_sort <span class="op">=</span> np.argsort(X_train[<span class="st">"Shell weight"</span>])</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit linear line to the scatterplot</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    plt.plot(X_train[[<span class="st">"Shell weight"</span>]].values.reshape(<span class="op">-</span><span class="dv">1</span>)[id_sort], y_poly_pred[id_sort], label<span class="op">=</span><span class="ss">f"Poly. </span><span class="sc">{</span>deg<span class="sc">}</span><span class="ss">"</span>, color<span class="op">=</span>col)</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>plt.scatter(x<span class="op">=</span>X_test[<span class="st">'Shell weight'</span>], y<span class="op">=</span>y_test, c<span class="op">=</span><span class="st">"green"</span>, label<span class="op">=</span><span class="st">"Test data"</span>)</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>plt.plot(X_train[<span class="st">'Shell weight'</span>], pred_train, <span class="st">'r'</span>, label<span class="op">=</span><span class="st">"Fitted line"</span>)</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Scatterplot of Rings vs Shell weight"</span>)</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab_Model_Evaluation_Refinement_sol_files/figure-html/cell-19-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p><strong>B.</strong> Perform <span class="math inline">\(10\)</span>-fold Cross-validation to tune the best penalization strength <span class="math inline">\(\alpha\)</span> of Ridge regression model for predicting <code>Rings</code>. Hint: see <a href="https://hassothea.github.io/Data_Analytics_AUPP/slides/Model_Evaluation_Refinement.html#/overcoming-overfitting-5">slide 24</a>. - We will build Ridge regression on full input data then compute Test MSE and compare it to the previous models.</p>
<div id="cell-45" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> Ridge</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="co"># List of all degrees to search over</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>alphas <span class="op">=</span> <span class="bu">list</span>(np.linspace(<span class="fl">0.00001</span>, <span class="dv">3</span>, <span class="dv">50</span>)) <span class="op">+</span> <span class="bu">list</span>(np.linspace(<span class="fl">3.1</span>, <span class="dv">100</span>, <span class="dv">50</span>))</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="co"># List to store all losses</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>loss <span class="op">=</span> []</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>test_mse <span class="op">=</span> []</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>coefficients <span class="op">=</span> {<span class="ss">f'alpha=</span><span class="sc">{</span>alpha<span class="sc">}</span><span class="ss">'</span>: [] <span class="cf">for</span> alpha <span class="kw">in</span> alphas}</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> alp <span class="kw">in</span> alphas:</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> Ridge(alpha<span class="op">=</span>alp)</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    mse <span class="op">=</span> <span class="op">-</span>cross_val_score(model, X_train, y_train, cv<span class="op">=</span><span class="dv">10</span>, </span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>                scoring<span class="op">=</span><span class="st">'neg_mean_squared_error'</span>).mean()</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    loss.append(mse)</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    model.fit(X_train, y_train)</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>    coefficients[<span class="ss">f'alpha=</span><span class="sc">{</span>alp<span class="sc">}</span><span class="ss">'</span>] <span class="op">=</span> model.coef_</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>    test_mse.append(mean_squared_error(y_test, model.predict(X_test)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-46" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">4</span>))</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>pd_coef <span class="op">=</span> pd.DataFrame(coefficients, index<span class="op">=</span>X_train.columns)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Test error</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].plot(alphas, test_mse, label<span class="op">=</span><span class="st">"Test MSE"</span>)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">"Test MSE at each penalty strength alpha"</span>)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].legend()</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xlabel(<span class="st">"alpha"</span>)</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xscale(<span class="st">'log'</span>)</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">"Test MSE"</span>)</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>id_min <span class="op">=</span> np.argmin(loss)</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Optimal regularization strength alpha for Ridge regression: </span><span class="sc">{</span>alphas[id_min]<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].plot(alphas, loss, label<span class="op">=</span><span class="st">"CV MSE"</span>)</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].vlines(x<span class="op">=</span>alphas[id_min], ymin<span class="op">=</span>np.<span class="bu">min</span>(loss), ymax<span class="op">=</span>np.<span class="bu">max</span>(loss), label<span class="op">=</span><span class="st">"optimal alpha"</span>, color<span class="op">=</span><span class="st">"red"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">"CV MSE at each penalty strength alpha"</span>)</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].legend()</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xscale(<span class="st">'log'</span>)</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">"alpha"</span>)</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">"CV MSE"</span>)</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">2</span>].plot(alphas, pd_coef.transpose(), label<span class="op">=</span>pd_coef.index)</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">2</span>].vlines(x<span class="op">=</span>alphas[id_min], ymin<span class="op">=</span>np.<span class="bu">min</span>(pd_coef), ymax<span class="op">=</span>np.<span class="bu">max</span>(pd_coef), label<span class="op">=</span><span class="st">"optimal alpha"</span>, color<span class="op">=</span><span class="st">"red"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">2</span>].set_title(<span class="st">"Coefs at each penalty strength alpha"</span>)</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">2</span>].legend()</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">2</span>].set_xscale(<span class="st">'log'</span>)</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">2</span>].set_xlabel(<span class="st">"alpha"</span>)</span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">2</span>].set_ylabel(<span class="st">"Coef"</span>)</span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Optimal regularization strength alpha for Ridge regression: 0.6734771428571428</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab_Model_Evaluation_Refinement_sol_files/figure-html/cell-21-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<blockquote class="blockquote">
<p>The first graph is the performance of Ridge regression at each value of <span class="math inline">\(\alpha\)</span> on the testing data. On the other hand, the second graph illustrates the performance of Ridge regression on cross-validation subsets. The last graph shows the values of the coefficients of the model at each value of penalty parameter <span class="math inline">\(\alpha\)</span>.</p>
</blockquote>
<blockquote class="blockquote">
<p>We can see that optimal strength <span class="math inline">\(\alpha\approx 0.67\)</span> by cross-validation method. The average CV MSE at this level of penalty strength is given below.</p>
</blockquote>
<div id="cell-48" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>All_Test_MSE[<span class="st">'Ridge'</span>] <span class="op">=</span> test_mse[id_min]</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>CV_ALL_MSE[<span class="st">'Ridge'</span>] <span class="op">=</span> loss[id_min]</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Cross-validation MSE: </span><span class="sc">{</span>loss[id_min]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Test MSE: </span><span class="sc">{</span>test_mse[id_min]<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Cross-validation MSE: 4.953797459164008
Test MSE: 5.126732705305683</code></pre>
</div>
</div>
<p><strong>C.</strong> Perform <span class="math inline">\(10\)</span>-fold Cross-validation to tune the best penalization strength <span class="math inline">\(\alpha\)</span> of Lasso regression model for predicting <code>Rings</code>. Hint: see <a href="https://hassothea.github.io/Data_Analytics_AUPP/slides/Model_Evaluation_Refinement.html#/overcoming-overfitting-5">slide 24</a>. - Compute Test MSE and compare it to the previous models. - How many inputs are retained by Lasso?</p>
<div id="cell-50" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> Lasso</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="co"># List of all degrees to search over</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>alphas <span class="op">=</span> <span class="bu">list</span>(np.linspace(<span class="fl">0.001</span>, <span class="dv">3</span>, <span class="dv">100</span>))</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co"># List to store all losses</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>loss <span class="op">=</span> []</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>test_mse <span class="op">=</span> []</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>coefficients <span class="op">=</span> {<span class="ss">f'alpha=</span><span class="sc">{</span>alpha<span class="sc">}</span><span class="ss">'</span>: [] <span class="cf">for</span> alpha <span class="kw">in</span> alphas}</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> alp <span class="kw">in</span> alphas:</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> Lasso(alpha<span class="op">=</span>alp)</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    mse <span class="op">=</span> <span class="op">-</span>cross_val_score(model, X_train, y_train, cv<span class="op">=</span><span class="dv">10</span>, </span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>                scoring<span class="op">=</span><span class="st">'neg_mean_squared_error'</span>).mean()</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>    loss.append(mse)</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>    model.fit(X_train, y_train)</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>    coefficients[<span class="ss">f'alpha=</span><span class="sc">{</span>alp<span class="sc">}</span><span class="ss">'</span>] <span class="op">=</span> model.coef_</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>    test_mse.append(mean_squared_error(y_test, model.predict(X_test)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-51" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">4</span>))</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>pd_coef <span class="op">=</span> pd.DataFrame(coefficients, index<span class="op">=</span>X_train.columns)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Test error</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].plot(alphas, test_mse, label<span class="op">=</span><span class="st">"Test MSE"</span>)</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">"Test MSE at each penalty strength alpha"</span>)</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].legend()</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xlabel(<span class="st">"alpha"</span>)</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="co"># axes[0].set_xscale('log')</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">"Test MSE"</span>)</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>id_min <span class="op">=</span> np.argmin(loss)</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Optimal regularization strength alpha for Lasso regression: </span><span class="sc">{</span>alphas[id_min]<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].plot(alphas, loss, label<span class="op">=</span><span class="st">"CV MSE"</span>)</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].vlines(x<span class="op">=</span>alphas[id_min], ymin<span class="op">=</span>np.<span class="bu">min</span>(loss), ymax<span class="op">=</span>np.<span class="bu">max</span>(loss), label<span class="op">=</span><span class="st">"optimal alpha"</span>, color<span class="op">=</span><span class="st">"red"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">"CV MSE at each penalty strength alpha"</span>)</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].legend()</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a><span class="co"># axes[1].set_xscale('log')</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">"alpha"</span>)</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">"CV MSE"</span>)</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">2</span>].plot(alphas, pd_coef.transpose(), label<span class="op">=</span>pd_coef.index)</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">2</span>].vlines(x<span class="op">=</span>alphas[id_min], ymin<span class="op">=</span>np.<span class="bu">min</span>(pd_coef), ymax<span class="op">=</span>np.<span class="bu">max</span>(pd_coef), label<span class="op">=</span><span class="st">"optimal alpha"</span>, color<span class="op">=</span><span class="st">"red"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">2</span>].set_title(<span class="st">"Coefs at each penalty strength alpha"</span>)</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">2</span>].legend()</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a><span class="co"># axes[2].set_xscale('log')</span></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">2</span>].set_xlabel(<span class="st">"alpha"</span>)</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">2</span>].set_ylabel(<span class="st">"Coef"</span>)</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Optimal regularization strength alpha for Lasso regression: 0.001</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab_Model_Evaluation_Refinement_sol_files/figure-html/cell-24-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-52" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>All_Test_MSE[<span class="st">'Lasso'</span>] <span class="op">=</span> test_mse[id_min]</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>CV_ALL_MSE[<span class="st">'Lasso'</span>] <span class="op">=</span> loss[id_min]</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Cross-validation MSE: </span><span class="sc">{</span>loss[id_min]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Test MSE: </span><span class="sc">{</span>test_mse[id_min]<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Cross-validation MSE: 4.995800296285283
Test MSE: 5.088192636942236</code></pre>
</div>
</div>
</section>
<section id="polynomial-with-regularitation" class="level2">
<h2 class="anchored" data-anchor-id="polynomial-with-regularitation">Polynomial with Regularitation</h2>
<p>Now we combine regularization with higher polynomial degree.</p>
<ul>
<li>Ridge regression</li>
</ul>
<div id="cell-54" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> Ridge</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="co"># List of all degrees to search over</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>poly <span class="op">=</span> PolynomialFeatures(degree<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>X_poly <span class="op">=</span> poly.fit_transform(X_train)</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>X_poly_test <span class="op">=</span> poly.transform(X_test)</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>alphas <span class="op">=</span> <span class="bu">list</span>(np.linspace(<span class="fl">0.00001</span>, <span class="dv">3</span>, <span class="dv">50</span>)) <span class="op">+</span> <span class="bu">list</span>(np.linspace(<span class="fl">3.1</span>, <span class="dv">100</span>, <span class="dv">50</span>))</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="co"># List to store all losses</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>loss <span class="op">=</span> []</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>test_mse <span class="op">=</span> []</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>coefficients <span class="op">=</span> {<span class="ss">f'alpha=</span><span class="sc">{</span>alpha<span class="sc">}</span><span class="ss">'</span>: [] <span class="cf">for</span> alpha <span class="kw">in</span> alphas}</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> alp <span class="kw">in</span> alphas:</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> Ridge(alpha<span class="op">=</span>alp)</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>    mse <span class="op">=</span> <span class="op">-</span>cross_val_score(model, X_poly, y_train, cv<span class="op">=</span><span class="dv">10</span>, </span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>                scoring<span class="op">=</span><span class="st">'neg_mean_squared_error'</span>).mean()</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>    loss.append(mse)</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit</span></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>    model.fit(X_poly, y_train)</span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>    coefficients[<span class="ss">f'alpha=</span><span class="sc">{</span>alp<span class="sc">}</span><span class="ss">'</span>] <span class="op">=</span> model.coef_</span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>    test_mse.append(mean_squared_error(y_test, model.predict(X_poly_test)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-55" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">4</span>))</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>pd_coef <span class="op">=</span> pd.DataFrame(coefficients, index<span class="op">=</span>poly.get_feature_names_out(input_features<span class="op">=</span>X_train.columns))</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Test error</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].plot(alphas, test_mse, label<span class="op">=</span><span class="st">"Test MSE"</span>)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">"Test MSE at each penalty strength alpha"</span>)</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].legend()</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xlabel(<span class="st">"alpha"</span>)</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xscale(<span class="st">'log'</span>)</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">"Test MSE"</span>)</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>id_min <span class="op">=</span> np.argmin(loss)</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Optimal regularization strength alpha for Ridge regression: </span><span class="sc">{</span>alphas[id_min]<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].plot(alphas, loss, label<span class="op">=</span><span class="st">"CV MSE"</span>)</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].vlines(x<span class="op">=</span>alphas[id_min], ymin<span class="op">=</span>np.<span class="bu">min</span>(loss), ymax<span class="op">=</span>np.<span class="bu">max</span>(loss), label<span class="op">=</span><span class="st">"optimal alpha"</span>, color<span class="op">=</span><span class="st">"red"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">"CV MSE at each penalty strength alpha"</span>)</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xscale(<span class="st">'log'</span>)</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">"alpha"</span>)</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">"CV MSE"</span>)</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">2</span>].plot(alphas, pd_coef.transpose(), label<span class="op">=</span>pd_coef.index)</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">2</span>].vlines(x<span class="op">=</span>alphas[id_min], ymin<span class="op">=</span>np.<span class="bu">min</span>(pd_coef), ymax<span class="op">=</span>np.<span class="bu">max</span>(pd_coef), label<span class="op">=</span><span class="st">"optimal alpha"</span>, color<span class="op">=</span><span class="st">"red"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">2</span>].set_title(<span class="st">"Coefs at each penalty strength alpha"</span>)</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">2</span>].set_xscale(<span class="st">'log'</span>)</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">2</span>].set_xlabel(<span class="st">"alpha"</span>)</span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">2</span>].set_ylabel(<span class="st">"Coef"</span>)</span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Optimal regularization strength alpha for Ridge regression: 0.30613142857142855</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab_Model_Evaluation_Refinement_sol_files/figure-html/cell-27-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-56" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>All_Test_MSE[<span class="st">'Poly-Ridge'</span>] <span class="op">=</span> test_mse[id_min]</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>CV_ALL_MSE[<span class="st">'Poly-Ridge'</span>] <span class="op">=</span> loss[id_min]</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Cross-validation MSE: </span><span class="sc">{</span>loss[id_min]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Test MSE: </span><span class="sc">{</span>test_mse[id_min]<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Cross-validation MSE: 4.647400669206419
Test MSE: 4.647813719255127</code></pre>
</div>
</div>
<ul>
<li>Lasso regression</li>
</ul>
<div id="cell-58" class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> Lasso</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="co"># List of all degrees to search over</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>alphas <span class="op">=</span> <span class="bu">list</span>(np.linspace(<span class="fl">0.00001</span>, <span class="dv">10</span>, <span class="dv">100</span>))</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="co"># List to store all losses</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>loss <span class="op">=</span> []</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>test_mse <span class="op">=</span> []</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>coefficients <span class="op">=</span> {<span class="ss">f'alpha=</span><span class="sc">{</span>alpha<span class="sc">}</span><span class="ss">'</span>: [] <span class="cf">for</span> alpha <span class="kw">in</span> alphas}</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> alp <span class="kw">in</span> alphas:</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> Lasso(alpha<span class="op">=</span>alp)</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>    mse <span class="op">=</span> <span class="op">-</span>cross_val_score(model, X_poly, y_train, cv<span class="op">=</span><span class="dv">10</span>, </span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>                scoring<span class="op">=</span><span class="st">'neg_mean_squared_error'</span>).mean()</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>    loss.append(mse)</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit</span></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>    model.fit(X_poly, y_train)</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>    coefficients[<span class="ss">f'alpha=</span><span class="sc">{</span>alp<span class="sc">}</span><span class="ss">'</span>] <span class="op">=</span> model.coef_</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>    test_mse.append(mean_squared_error(y_test, model.predict(X_poly_test)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-59" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">4</span>))</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>pd_coef <span class="op">=</span> pd.DataFrame(coefficients, index<span class="op">=</span>poly.get_feature_names_out(input_features<span class="op">=</span>X_train.columns))</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Test error</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].plot(alphas, test_mse, label<span class="op">=</span><span class="st">"Test MSE"</span>)</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">"Test MSE at each penalty strength alpha"</span>)</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].legend()</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xlabel(<span class="st">"alpha"</span>)</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xscale(<span class="st">'log'</span>)</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">"Test MSE"</span>)</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>id_min <span class="op">=</span> np.argmin(loss)</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Optimal regularization strength alpha for Ridge regression: </span><span class="sc">{</span>alphas[id_min]<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].plot(alphas, loss, label<span class="op">=</span><span class="st">"CV MSE"</span>)</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].vlines(x<span class="op">=</span>alphas[id_min], ymin<span class="op">=</span>np.<span class="bu">min</span>(loss), ymax<span class="op">=</span>np.<span class="bu">max</span>(loss), label<span class="op">=</span><span class="st">"optimal alpha"</span>, color<span class="op">=</span><span class="st">"red"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">"CV MSE at each penalty strength alpha"</span>)</span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xscale(<span class="st">'log'</span>)</span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">"alpha"</span>)</span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">"CV MSE"</span>)</span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">2</span>].plot(alphas, pd_coef.transpose(), label<span class="op">=</span>pd_coef.index)</span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">2</span>].vlines(x<span class="op">=</span>alphas[id_min], ymin<span class="op">=</span>np.<span class="bu">min</span>(pd_coef), ymax<span class="op">=</span>np.<span class="bu">max</span>(pd_coef), label<span class="op">=</span><span class="st">"optimal alpha"</span>, color<span class="op">=</span><span class="st">"red"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)</span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">2</span>].set_title(<span class="st">"Coefs at each penalty strength alpha"</span>)</span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">2</span>].set_xscale(<span class="st">'log'</span>)</span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">2</span>].set_xlabel(<span class="st">"alpha"</span>)</span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">2</span>].set_ylabel(<span class="st">"Coef"</span>)</span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Optimal regularization strength alpha for Ridge regression: 1e-05</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab_Model_Evaluation_Refinement_sol_files/figure-html/cell-30-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-60" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>All_Test_MSE[<span class="st">'Poly-Lasso'</span>] <span class="op">=</span> test_mse[id_min]</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>CV_ALL_MSE[<span class="st">'Poly-Lasso'</span>] <span class="op">=</span> loss[id_min]</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Cross-validation MSE: </span><span class="sc">{</span>loss[id_min]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Test MSE: </span><span class="sc">{</span>test_mse[id_min]<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Cross-validation MSE: 6.485597009720304
Test MSE: 4.520971235467517</code></pre>
</div>
</div>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<ul>
<li><p>According to test MSE, polynomial features with Lasso constraint seems to perform better than other methods.</p></li>
<li><p>However, polynomial features with Ridge constraint seems to perform slightly better than the others in terms of Cross-validation MSE suggesting that it is more suitable in generalizing to new unseen observations.</p></li>
<li><p>We report the overall performances in the following tables.</p></li>
<li><p>Note that this analysis is done based on the whole data without taking in account the effect of outliers.</p></li>
<li><p>This dataset contains a lot of outliers and methods that takes into account clustering structure of the input might be suitable for such a dataset, for example, See <a href="https://hassothea.github.io/files/CodesPhD/KFCReg.html">KFC Procedure, Has et al.&nbsp;(2021)</a>.</p></li>
</ul>
<div id="cell-62" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Test MSE of all methods:'</span>)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>df1 <span class="op">=</span> pd.DataFrame(All_Test_MSE, index<span class="op">=</span>[<span class="st">'MSE'</span>])</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">5</span>))</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> sns.barplot(df1.melt(), x<span class="op">=</span><span class="st">"variable"</span>, y<span class="op">=</span><span class="st">"value"</span>)</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>ax.tick_params(labelrotation <span class="op">=</span> <span class="dv">45</span>)</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>ax.bar_label(ax.containers[<span class="dv">0</span>], fontsize<span class="op">=</span><span class="dv">10</span>, rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Method"</span>)</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Test MSE"</span>)</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>df1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Test MSE of all methods:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="31">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">SLR</th>
<th data-quarto-table-cell-role="th">Poly. 2</th>
<th data-quarto-table-cell-role="th">Poly. 3</th>
<th data-quarto-table-cell-role="th">Poly. 4</th>
<th data-quarto-table-cell-role="th">Poly. 5</th>
<th data-quarto-table-cell-role="th">Poly. 6</th>
<th data-quarto-table-cell-role="th">Poly. 7</th>
<th data-quarto-table-cell-role="th">Poly. 8</th>
<th data-quarto-table-cell-role="th">Poly. 9</th>
<th data-quarto-table-cell-role="th">Poly. 10</th>
<th data-quarto-table-cell-role="th">Ridge</th>
<th data-quarto-table-cell-role="th">Lasso</th>
<th data-quarto-table-cell-role="th">Poly-Ridge</th>
<th data-quarto-table-cell-role="th">Poly-Lasso</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">MSE</td>
<td>5.049255</td>
<td>6.758753</td>
<td>6.512433</td>
<td>6.524356</td>
<td>6.580672</td>
<td>6.56465</td>
<td>6.572854</td>
<td>6.545954</td>
<td>6.542486</td>
<td>6.555271</td>
<td>5.126733</td>
<td>5.088193</td>
<td>4.647814</td>
<td>4.520971</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab_Model_Evaluation_Refinement_sol_files/figure-html/cell-32-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-63" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Corss validation of all methods:"</span>)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>df2 <span class="op">=</span> pd.DataFrame(CV_ALL_MSE, index<span class="op">=</span>[<span class="st">"MSE"</span>])</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">5</span>))</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> sns.barplot(df2.melt(), x<span class="op">=</span><span class="st">"variable"</span>, y<span class="op">=</span><span class="st">"value"</span>)</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>ax.tick_params(labelrotation <span class="op">=</span> <span class="dv">45</span>)</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>ax.bar_label(ax.containers[<span class="dv">0</span>], fontsize<span class="op">=</span><span class="dv">10</span>, rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Method"</span>)</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"CV MSE"</span>)</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>df2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Corss validation of all methods:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="32">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Poly. 2</th>
<th data-quarto-table-cell-role="th">Poly. 3</th>
<th data-quarto-table-cell-role="th">Poly. 4</th>
<th data-quarto-table-cell-role="th">Poly. 5</th>
<th data-quarto-table-cell-role="th">Poly. 6</th>
<th data-quarto-table-cell-role="th">Poly. 7</th>
<th data-quarto-table-cell-role="th">Poly. 8</th>
<th data-quarto-table-cell-role="th">Poly. 9</th>
<th data-quarto-table-cell-role="th">Poly. 10</th>
<th data-quarto-table-cell-role="th">Ridge</th>
<th data-quarto-table-cell-role="th">Lasso</th>
<th data-quarto-table-cell-role="th">Poly-Ridge</th>
<th data-quarto-table-cell-role="th">Poly-Lasso</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">MSE</td>
<td>6.005101</td>
<td>5.923215</td>
<td>5.893669</td>
<td>5.88341</td>
<td>5.876838</td>
<td>6.013628</td>
<td>6.338744</td>
<td>6.063998</td>
<td>28.442479</td>
<td>4.953797</td>
<td>4.9958</td>
<td>4.647401</td>
<td>6.485597</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab_Model_Evaluation_Refinement_sol_files/figure-html/cell-33-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="further-readings" class="level1">
<h1>Further readings</h1>
<ul>
<li>Graphical tools:
<ul>
<li><a href="https://matplotlib.org/stable/index.html"><code>matplotlib</code></a></li>
<li><a href="https://seaborn.pydata.org/"><code>seaborn</code></a></li>
<li><a href="https://plotly.com/python/"><code>plotly</code></a></li>
</ul></li>
<li><a href="https://scikit-learn.org/1.5/modules/generated/sklearn.linear_model.Ridge.html">Ridge, Sklearn</a></li>
<li><a href="https://scikit-learn.org/stable/modules/generated/sklearn.linear_model.Lasso.html">Lasso, Sklearn</a></li>
<li><a href="https://www.statlearning.com/">Chapter 5, Introduction to Statistical Learning, James et al.&nbsp;(2023)</a></li>
</ul>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>